<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Browser Use Control Room</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #ebe3d6;
      --ink: #1f2931;
      --muted: #5f6e76;
      --panel: rgba(255, 252, 244, 0.84);
      --panel-solid: #fff9ee;
      --line: rgba(25, 38, 45, 0.13);
      --brand: #0f766e;
      --brand-deep: #0a4f4b;
      --accent: #cc5a21;
      --good: #2c8b5c;
      --warn: #ad6e1f;
      --bad: #b0421d;
      --shadow: 0 22px 48px rgba(17, 33, 40, 0.14);
      --ring: rgba(15, 118, 110, 0.25);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      min-height: 100%;
    }

    body {
      font-family: "Manrope", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 660px at -20% -20%, #d5ebe0 0%, transparent 60%),
        radial-gradient(900px 480px at 115% -10%, #f7dcb9 0%, transparent 60%),
        linear-gradient(145deg, #f5efe2 0%, #e8dccb 100%);
      overflow-x: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: 0.32;
      background-image: radial-gradient(rgba(29, 45, 54, 0.09) 0.7px, transparent 0.7px);
      background-size: 8px 8px;
    }

    .shell {
      position: relative;
      z-index: 1;
      max-width: 1460px;
      margin: 0 auto;
      padding: 24px 18px 34px;
    }

    .top {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 14px;
      margin-bottom: 14px;
    }

    .card {
      border: 1px solid var(--line);
      border-radius: 18px;
      background: var(--panel);
      box-shadow: var(--shadow);
      backdrop-filter: blur(7px);
      padding: 16px;
    }

    .title {
      margin: 0 0 8px;
      font-size: clamp(24px, 3.8vw, 42px);
      line-height: 1.02;
      letter-spacing: -0.02em;
      font-weight: 800;
    }

    .subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
      max-width: 64ch;
    }

    .kpis {
      margin-top: 14px;
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 10px;
    }

    .kpi {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      min-height: 80px;
      padding: 10px;
    }

    .kpi-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.11em;
      color: #5f6b72;
      font-weight: 700;
    }

    .kpi-value {
      margin-top: 8px;
      font-size: 27px;
      font-weight: 800;
      line-height: 1;
    }

    .tiny {
      margin-top: 5px;
      color: var(--muted);
      font-size: 11px;
      min-height: 14px;
    }

    .pulse {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      font-size: 13px;
      color: #2d3b42;
      font-weight: 600;
    }

    .dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: var(--good);
      box-shadow: 0 0 0 0 rgba(44, 139, 92, 0.45);
      animation: pulse 1.7s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(44, 139, 92, 0.45); }
      75% { box-shadow: 0 0 0 11px rgba(44, 139, 92, 0); }
      100% { box-shadow: 0 0 0 0 rgba(44, 139, 92, 0); }
    }

    .mono {
      font-family: "IBM Plex Mono", monospace;
    }

    .clock {
      font-family: "IBM Plex Mono", monospace;
      font-size: 12px;
      color: #3f5059;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px 10px;
      background: rgba(255, 255, 255, 0.84);
      margin-left: auto;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .top-actions {
      margin-top: 10px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items: end;
    }

    .stack {
      display: grid;
      gap: 8px;
    }

    .label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #607078;
      font-weight: 700;
    }

    input,
    textarea,
    select,
    button {
      font: inherit;
    }

    input,
    textarea,
    select {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 11px;
      background: #fff;
      color: var(--ink);
      padding: 10px 12px;
      font-family: "IBM Plex Mono", monospace;
      font-size: 13px;
      outline: none;
      transition: border-color 120ms, box-shadow 120ms;
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px var(--ring);
    }

    textarea {
      resize: vertical;
      min-height: 90px;
      line-height: 1.35;
    }

    .btn {
      border: 1px solid transparent;
      border-radius: 11px;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 100ms ease, filter 140ms ease;
      white-space: nowrap;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--brand) 0%, var(--brand-deep) 100%);
      color: #fff;
      box-shadow: 0 8px 18px rgba(10, 79, 75, 0.26);
    }

    .btn-secondary {
      background: #fff;
      border-color: var(--line);
      color: #243339;
    }

    .btn-danger {
      background: #fff3ef;
      color: #99391e;
      border-color: #efc9bc;
    }

    .btn:hover {
      filter: brightness(1.03);
    }

    .badge-row {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .badge {
      font-size: 11px;
      font-weight: 700;
      border-radius: 999px;
      padding: 5px 9px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.84);
    }

    .grid {
      display: grid;
      grid-template-columns: 380px minmax(0, 1fr);
      gap: 14px;
      align-items: start;
    }

    .compose {
      position: sticky;
      top: 10px;
    }

    .compose-grid {
      display: grid;
      gap: 9px;
    }

    .row2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 9px;
    }

    .status-box {
      border: 1px dashed var(--line);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.68);
      color: #475761;
      padding: 10px;
      font-size: 12px;
      line-height: 1.35;
      min-height: 42px;
      word-break: break-word;
    }

    .panel-title {
      margin: 0;
      font-size: 18px;
      letter-spacing: -0.01em;
    }

    .panel-note {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }

    .body {
      display: grid;
      gap: 14px;
    }

    .filters {
      display: grid;
      grid-template-columns: 1fr 1.2fr 0.75fr 0.7fr 0.8fr 0.65fr auto;
      gap: 10px;
      align-items: end;
      margin-top: 12px;
    }

    .hint {
      margin-top: 7px;
      color: var(--muted);
      font-size: 11px;
      line-height: 1.4;
    }

    .nodes {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 10px;
    }

    .node {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      padding: 11px;
      min-height: 108px;
    }

    .node-id {
      font-size: 12px;
      font-family: "IBM Plex Mono", monospace;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .node-meta {
      margin-top: 8px;
      display: grid;
      gap: 2px;
      color: #4c5b63;
      font-size: 11px;
      font-family: "IBM Plex Mono", monospace;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 800;
      line-height: 1;
    }

    .pill-ready { background: #dff5e8; color: #1e7a4b; }
    .pill-warming { background: #f7eecf; color: #8a6816; }
    .pill-leased { background: #daedfb; color: #1f6484; }
    .pill-draining { background: #ede4f7; color: #6b488e; }
    .pill-dead { background: #f8e0d9; color: #93381f; }
    .pill-queued { background: #f2e8d3; color: #8c6313; }
    .pill-running { background: #d7ebff; color: #225f88; }
    .pill-completed { background: #dff5e8; color: #1d7a4d; }
    .pill-failed { background: #f9dfd8; color: #9a3219; }
    .pill-blocker { background: #fde9d7; color: #a14f1c; }

    .tasks-grid {
      margin-top: 10px;
      display: grid;
      grid-template-columns: minmax(0, 1fr) 350px;
      gap: 10px;
      align-items: start;
    }

    .table-wrap {
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow: auto;
      background: #fff;
      min-height: 420px;
      max-height: 70vh;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 840px;
    }

    th,
    td {
      text-align: left;
      padding: 10px 11px;
      border-bottom: 1px solid rgba(27, 40, 47, 0.1);
      font-size: 12px;
      vertical-align: middle;
    }

    th {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #5a6870;
      position: sticky;
      top: 0;
      z-index: 3;
      background: #f6f0e2;
    }

    tr {
      cursor: pointer;
    }

    tr:hover td {
      background: #f8fcfb;
    }

    tr.active td {
      background: #e6f5f2;
    }

    .detail {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      min-height: 420px;
      max-height: 70vh;
      overflow: auto;
      padding: 12px;
    }

    .detail-header {
      display: grid;
      gap: 5px;
      margin-bottom: 10px;
    }

    .detail-id {
      font-family: "IBM Plex Mono", monospace;
      font-size: 12px;
      font-weight: 600;
      word-break: break-all;
    }

    .detail-list {
      display: grid;
      gap: 8px;
      margin-top: 10px;
    }

    .pair {
      border: 1px solid var(--line);
      border-radius: 9px;
      padding: 8px;
      background: #fefcf6;
    }

    .pair .k {
      display: block;
      color: #5f6f77;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      font-weight: 700;
    }

    .pair .v {
      margin-top: 4px;
      display: block;
      font-size: 12px;
      color: #23333a;
      line-height: 1.4;
      word-break: break-word;
    }

    .json {
      margin: 0;
      border: 1px solid var(--line);
      border-radius: 9px;
      padding: 9px;
      background: #fbf7ec;
      white-space: pre-wrap;
      font-size: 11px;
      line-height: 1.42;
      font-family: "IBM Plex Mono", monospace;
      max-height: 220px;
      overflow: auto;
    }

    .detail-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .link {
      color: #145f86;
      text-decoration: none;
      font-weight: 700;
    }

    .link:hover {
      text-decoration: underline;
    }

    .link-btn {
      border: 0;
      background: transparent;
      color: #145f86;
      font-weight: 700;
      cursor: pointer;
      padding: 0;
      text-decoration: underline;
      text-underline-offset: 2px;
      font-family: "IBM Plex Mono", monospace;
      font-size: 12px;
    }

    .empty {
      border: 1px dashed var(--line);
      border-radius: 11px;
      padding: 20px;
      text-align: center;
      color: #5d6b73;
      font-size: 13px;
      background: rgba(255, 255, 255, 0.65);
    }

    .errors {
      margin-top: 10px;
      display: grid;
      gap: 7px;
    }

    .error-item {
      border: 1px solid #efc3b7;
      background: #fff5f2;
      border-radius: 10px;
      padding: 9px;
      font-size: 12px;
      color: #79331a;
      line-height: 1.4;
    }

    .error-id {
      font-family: "IBM Plex Mono", monospace;
      font-size: 11px;
      font-weight: 600;
    }

    .foot {
      margin-top: 10px;
      font-size: 11px;
      color: #56656d;
    }

    .modal {
      position: fixed;
      inset: 0;
      z-index: 10;
      background: rgba(14, 25, 30, 0.66);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 14px;
    }

    .modal.show {
      display: flex;
    }

    .modal-card {
      width: min(1080px, 100%);
      max-height: 92vh;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: var(--panel-solid);
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .modal-head {
      border-bottom: 1px solid var(--line);
      padding: 9px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-size: 12px;
    }

    .modal img {
      display: block;
      width: 100%;
      max-height: calc(92vh - 50px);
      object-fit: contain;
      background: #f3ecde;
    }

    @media (max-width: 1320px) {
      .kpis {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .tasks-grid {
        grid-template-columns: 1fr;
      }

      .detail,
      .table-wrap {
        max-height: none;
      }
    }

    @media (max-width: 1090px) {
      .top {
        grid-template-columns: 1fr;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      .compose {
        position: static;
      }

      .filters {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 680px) {
      .shell {
        padding: 14px 10px 24px;
      }

      .kpis {
        grid-template-columns: 1fr 1fr;
      }

      .row2,
      .top-actions,
      .filters {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main class="shell">
    <section class="top">
      <article class="card">
        <h1 class="title">Browser Use Control Room</h1>
        <p class="subtitle">Local-first orchestration cockpit with live fleet state, queue diagnostics, and fast task replay for agent debugging.</p>
        <div class="kpis">
          <div class="kpi">
            <div class="kpi-label">Nodes</div>
            <div class="kpi-value" id="kpi-nodes">0</div>
            <div class="tiny" id="kpi-nodes-note">Fleet size</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Ready Nodes</div>
            <div class="kpi-value" id="kpi-ready">0</div>
            <div class="tiny">Available now</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Queued</div>
            <div class="kpi-value" id="kpi-queued">0</div>
            <div class="tiny">Waiting for worker</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Running</div>
            <div class="kpi-value" id="kpi-running">0</div>
            <div class="tiny">In progress</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Success Rate</div>
            <div class="kpi-value" id="kpi-success">0%</div>
            <div class="tiny">Completed / terminal</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Avg Runtime</div>
            <div class="kpi-value" id="kpi-runtime">-</div>
            <div class="tiny">Completed + failed</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Blocked</div>
            <div class="kpi-value" id="kpi-blocked">0</div>
            <div class="tiny">Challenge hits</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Block Rate</div>
            <div class="kpi-value" id="kpi-block-rate">0%</div>
            <div class="tiny">Blocked / failed</div>
          </div>
        </div>
      </article>

      <article class="card">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
          <div class="pulse"><span class="dot"></span><span id="live-label">Live polling enabled</span></div>
          <div class="clock" id="clock">-</div>
        </div>
        <p class="panel-note" style="margin-top:10px">Refreshes <span class="mono">/v1/nodes</span> and <span class="mono" id="task-limit-label">/v1/tasks?limit=120</span> automatically. Use the controls below to tune the live view.</p>
        <div class="top-actions">
          <div class="stack">
            <label class="label" for="refresh-ms">Refresh Interval</label>
            <select id="refresh-ms">
              <option value="1000">1 second</option>
              <option value="3000" selected>3 seconds</option>
              <option value="5000">5 seconds</option>
              <option value="10000">10 seconds</option>
            </select>
          </div>
          <div class="stack">
            <label class="label" for="task-limit">Fetch Limit</label>
            <select id="task-limit">
              <option value="80">80</option>
              <option value="120" selected>120</option>
              <option value="200">200</option>
            </select>
          </div>
        </div>
        <div class="badge-row">
          <button class="btn btn-secondary" id="toggle-live-btn" type="button">Pause Live Updates</button>
          <button class="btn btn-primary" id="refresh-now-btn" type="button">Refresh Now</button>
          <span class="badge mono" id="refresh-status">Waiting for first refresh</span>
        </div>
      </article>
    </section>

    <section class="grid">
      <aside class="card compose">
        <h2 class="panel-title">Create Task</h2>
        <p class="panel-note">Queue deterministic actions or planner goals. Presets are included for faster debugging loops.</p>
        <form class="compose-grid" id="task-form">
          <div>
            <label class="label" for="preset">Quick Preset</label>
            <select id="preset">
              <option value="">Custom</option>
              <option value="duck-search">DuckDuckGo search</option>
              <option value="wiki-search">Wikipedia search</option>
              <option value="open-url">Open URL only</option>
            </select>
          </div>
          <div>
            <label class="label" for="tenant-id">Tenant ID</label>
            <input id="tenant-id" value="dashboard" autocomplete="off">
          </div>
          <div class="row2">
            <div>
              <label class="label" for="session-id">Session ID</label>
              <input id="session-id" placeholder="sess_...">
            </div>
            <div style="display:flex;align-items:end;">
              <button class="btn btn-secondary" id="create-session-btn" type="button" style="width:100%;">Create Session</button>
            </div>
          </div>
          <div>
            <label class="label" for="task-url">URL</label>
            <input id="task-url" value="https://duckduckgo.com" autocomplete="off">
          </div>
          <div>
            <label class="label" for="task-goal">Goal</label>
            <input id="task-goal" value="search for browser use" autocomplete="off">
          </div>
          <div class="row2">
            <div>
              <label class="label" for="task-retries">Max Retries</label>
              <input id="task-retries" type="number" min="0" max="10" value="1">
            </div>
            <div style="display:flex;align-items:end;">
              <button class="btn btn-primary" type="submit" style="width:100%;">Queue Task</button>
            </div>
          </div>
          <div>
            <label class="label" for="task-actions">Actions JSON (optional)</label>
            <textarea id="task-actions" placeholder='[{"type":"wait_for","selector":"input[name="q"]","timeout_ms":8000},{"type":"type","selector":"input[name="q"]","text":"browser use"}]'></textarea>
          </div>
        </form>
        <p class="hint">Empty actions use planner mode from the goal. Non-empty actions run deterministically and bypass planner ambiguity.</p>
        <div class="status-box" id="create-status">No task submitted yet.</div>
      </aside>

      <div class="body">
        <section class="card">
          <h2 class="panel-title">Node Fleet</h2>
          <p class="panel-note">Heartbeat view of all node agents currently visible to the orchestrator.</p>
          <div class="nodes" id="nodes"></div>
        </section>

        <section class="card">
          <h2 class="panel-title">Task Feed</h2>
          <p class="panel-note">Filter and inspect task execution details. Select a row to open full metadata and replay the same payload.</p>
          <div class="filters">
            <div class="stack">
              <label class="label" for="filter-status">Status</label>
              <select id="filter-status">
                <option value="all" selected>all</option>
                <option value="queued">queued</option>
                <option value="running">running</option>
                <option value="completed">completed</option>
                <option value="failed">failed</option>
              </select>
            </div>
            <div class="stack">
              <label class="label" for="filter-query">Search</label>
              <input id="filter-query" placeholder="task id, goal, url, node, error" autocomplete="off">
            </div>
            <div class="stack">
              <label class="label" for="filter-artifact">Artifact</label>
              <select id="filter-artifact">
                <option value="all" selected>all</option>
                <option value="yes">has artifact</option>
                <option value="no">no artifact</option>
              </select>
            </div>
            <div class="stack">
              <label class="label" for="filter-only-failed">Failures</label>
              <select id="filter-only-failed">
                <option value="off" selected>include all</option>
                <option value="on">only failed</option>
              </select>
            </div>
            <div class="stack">
              <label class="label" for="filter-blocker">Blocker</label>
              <select id="filter-blocker">
                <option value="all" selected>all</option>
                <option value="yes">blocked only</option>
                <option value="no">non-blocked</option>
              </select>
            </div>
            <div class="stack">
              <label class="label" for="sort-order">Sort</label>
              <select id="sort-order">
                <option value="newest" selected>newest</option>
                <option value="oldest">oldest</option>
              </select>
            </div>
            <button class="btn btn-secondary" type="button" id="clear-filters-btn">Clear</button>
          </div>

          <div class="tasks-grid">
            <div class="table-wrap" id="tasks-wrap">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Status</th>
                    <th>Goal</th>
                    <th>URL</th>
                    <th>Node</th>
                    <th>Attempts</th>
                    <th>Created</th>
                    <th>Duration</th>
                    <th>Blocker</th>
                    <th>Artifact</th>
                  </tr>
                </thead>
                <tbody id="tasks-body"></tbody>
              </table>
            </div>

            <aside class="detail" id="task-detail">
              <div class="empty">Select a task row to inspect full details.</div>
            </aside>
          </div>

          <div class="hint" id="tasks-count">0 tasks shown.</div>
          <div class="empty" id="tasks-empty" style="display:none; margin-top:10px;">No tasks match current filters.</div>
        </section>

        <section class="card">
          <h2 class="panel-title">Recent Failures</h2>
          <p class="panel-note">Quick triage list from latest failed tasks.</p>
          <div class="errors" id="errors"></div>
          <div class="foot mono" id="footer-meta">-</div>
        </section>
      </div>
    </section>
  </main>

  <div class="modal" id="image-modal">
    <div class="modal-card">
      <div class="modal-head">
        <strong class="mono" id="image-title">Screenshot</strong>
        <button class="btn btn-secondary" type="button" id="image-close">Close</button>
      </div>
      <img id="image-preview" alt="Task screenshot preview">
    </div>
  </div>

  <script>
    const state = {
      nodes: [],
      tasks: [],
      filteredTasks: [],
      selectedTaskID: "",
      lastCreatedTaskID: "",
      refreshMs: 3000,
      taskLimit: 120,
      isLive: true,
      timer: null,
      filters: {
        status: "all",
        query: "",
        artifact: "all",
        onlyFailed: false,
        blocker: "all",
        sort: "newest"
      }
    };

    const nodesEl = document.getElementById("nodes");
    const tasksBodyEl = document.getElementById("tasks-body");
    const tasksWrapEl = document.getElementById("tasks-wrap");
    const tasksEmptyEl = document.getElementById("tasks-empty");
    const tasksCountEl = document.getElementById("tasks-count");
    const taskDetailEl = document.getElementById("task-detail");
    const errorsEl = document.getElementById("errors");
    const refreshStatusEl = document.getElementById("refresh-status");
    const createStatusEl = document.getElementById("create-status");
    const footerMetaEl = document.getElementById("footer-meta");
    const liveLabelEl = document.getElementById("live-label");

    const imageModalEl = document.getElementById("image-modal");
    const imagePreviewEl = document.getElementById("image-preview");
    const imageTitleEl = document.getElementById("image-title");

    function escapeHTML(value) {
      return String(value || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function fmtTime(value) {
      if (!value) return "-";
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return "-";
      return date.toLocaleString();
    }

    function parseTime(value) {
      if (!value) return null;
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return null;
      return date;
    }

    function durationForTask(task) {
      const start = parseTime(task.started_at);
      const end = parseTime(task.completed_at);
      if (!start || !end) return "-";
      const ms = end.getTime() - start.getTime();
      if (ms < 0) return "-";
      if (ms < 1000) return ms + "ms";
      if (ms < 60000) return (ms / 1000).toFixed(1) + "s";
      return (ms / 60000).toFixed(1) + "m";
    }

    function avgRuntime(tasks) {
      const terminal = tasks.filter((task) => task.started_at && task.completed_at);
      if (!terminal.length) return "-";
      let total = 0;
      let count = 0;
      for (const task of terminal) {
        const start = parseTime(task.started_at);
        const end = parseTime(task.completed_at);
        if (!start || !end) continue;
        const delta = end.getTime() - start.getTime();
        if (delta < 0) continue;
        total += delta;
        count += 1;
      }
      if (!count) return "-";
      const mean = Math.round(total / count);
      if (mean < 1000) return mean + "ms";
      if (mean < 60000) return (mean / 1000).toFixed(1) + "s";
      return (mean / 60000).toFixed(1) + "m";
    }

    function statusPillClass(status) {
      const normalized = String(status || "").toLowerCase();
      if (normalized === "ready") return "pill-ready";
      if (normalized === "warming") return "pill-warming";
      if (normalized === "leased") return "pill-leased";
      if (normalized === "draining") return "pill-draining";
      if (normalized === "dead") return "pill-dead";
      if (normalized === "queued") return "pill-queued";
      if (normalized === "running") return "pill-running";
      if (normalized === "completed") return "pill-completed";
      if (normalized === "failed") return "pill-failed";
      return "pill-warming";
    }

    function taskSuccessRate(tasks) {
      const terminal = tasks.filter((task) => task.status === "completed" || task.status === "failed");
      if (!terminal.length) return "0%";
      const completed = terminal.filter((task) => task.status === "completed").length;
      return Math.round((completed / terminal.length) * 100) + "%";
    }

    function taskBlockRate(tasks) {
      const failed = tasks.filter((task) => task.status === "failed");
      if (!failed.length) return "0%";
      const blocked = failed.filter((task) => Boolean(task.blocker_type)).length;
      return Math.round((blocked / failed.length) * 100) + "%";
    }

    function compactText(value, max) {
      const text = String(value || "");
      if (text.length <= max) return text;
      return text.slice(0, max - 3) + "...";
    }

    function updateClock() {
      document.getElementById("clock").textContent = new Date().toLocaleString();
    }

    function updateKPIs() {
      const tasks = state.tasks;
      const nodes = state.nodes;
      const ready = nodes.filter((node) => node.state === "ready").length;
      const queued = tasks.filter((task) => task.status === "queued").length;
      const running = tasks.filter((task) => task.status === "running").length;
      const blocked = tasks.filter((task) => Boolean(task.blocker_type)).length;

      document.getElementById("kpi-nodes").textContent = String(nodes.length);
      document.getElementById("kpi-ready").textContent = String(ready);
      document.getElementById("kpi-queued").textContent = String(queued);
      document.getElementById("kpi-running").textContent = String(running);
      document.getElementById("kpi-success").textContent = taskSuccessRate(tasks);
      document.getElementById("kpi-runtime").textContent = avgRuntime(tasks);
      document.getElementById("kpi-blocked").textContent = String(blocked);
      document.getElementById("kpi-block-rate").textContent = taskBlockRate(tasks);
      document.getElementById("kpi-nodes-note").textContent = ready + " ready / " + nodes.length + " total";
    }

    function applyFilters() {
      const q = state.filters.query.trim().toLowerCase();
      const sort = state.filters.sort;

      let items = state.tasks.filter((task) => {
        if (state.filters.status !== "all" && task.status !== state.filters.status) return false;
        if (state.filters.onlyFailed && task.status !== "failed") return false;

        const hasArtifact = Boolean(task.screenshot_artifact_url);
        if (state.filters.artifact === "yes" && !hasArtifact) return false;
        if (state.filters.artifact === "no" && hasArtifact) return false;

        const hasBlocker = Boolean(task.blocker_type);
        if (state.filters.blocker === "yes" && !hasBlocker) return false;
        if (state.filters.blocker === "no" && hasBlocker) return false;

        if (!q) return true;
        const blob = [task.id, task.goal, task.url, task.final_url, task.node_id, task.error_message, task.blocker_type, task.blocker_message]
          .map((part) => String(part || "").toLowerCase())
          .join(" ");
        return blob.includes(q);
      });

      items.sort((a, b) => {
        const aDate = parseTime(a.created_at);
        const bDate = parseTime(b.created_at);
        const aTime = aDate ? aDate.getTime() : 0;
        const bTime = bDate ? bDate.getTime() : 0;

        if (sort === "oldest") {
          if (aTime === bTime) return String(a.id || "").localeCompare(String(b.id || ""));
          return aTime - bTime;
        }
        if (aTime === bTime) return String(b.id || "").localeCompare(String(a.id || ""));
        return bTime - aTime;
      });

      state.filteredTasks = items;
      tasksCountEl.textContent = items.length + " tasks shown (from " + state.tasks.length + " fetched).";
    }

    function renderNodes() {
      if (!state.nodes.length) {
        nodesEl.innerHTML = '<div class="empty" style="grid-column:1/-1;">No nodes registered yet.</div>';
        return;
      }

      nodesEl.innerHTML = state.nodes.map((node) => {
        return (
          '<article class="node">' +
            '<div style="display:flex;justify-content:space-between;gap:8px;align-items:start;">' +
              '<div class="node-id" title="' + escapeHTML(node.id) + '">' + escapeHTML(node.id || '-') + '</div>' +
              '<span class="pill ' + statusPillClass(node.state) + '">' + escapeHTML(node.state || 'unknown') + '</span>' +
            '</div>' +
            '<div class="node-meta">' +
              '<div>addr: ' + escapeHTML(node.address || '-') + '</div>' +
              '<div>ver: ' + escapeHTML(node.version || 'dev') + '</div>' +
              '<div>boot: ' + escapeHTML(fmtTime(node.booted_at)) + '</div>' +
              '<div>hb: ' + escapeHTML(fmtTime(node.last_heartbeat)) + '</div>' +
            '</div>' +
          '</article>'
        );
      }).join('');
    }

    function renderTaskTable() {
      if (!state.filteredTasks.length) {
        tasksWrapEl.style.display = 'none';
        tasksEmptyEl.style.display = 'block';
        tasksBodyEl.innerHTML = '';
        return;
      }

      tasksWrapEl.style.display = 'block';
      tasksEmptyEl.style.display = 'none';

      tasksBodyEl.innerHTML = state.filteredTasks.map((task) => {
        const isSelected = task.id === state.selectedTaskID;
        const isCreated = task.id === state.lastCreatedTaskID;
        const rowClass = isSelected ? ' class="active"' : '';
        const idStyle = isCreated ? ' style="font-weight:700;color:#115d55"' : '';
        const artifact = task.screenshot_artifact_url
          ? '<a class="link" href="' + escapeHTML(task.screenshot_artifact_url) + '" data-artifact="' + escapeHTML(task.screenshot_artifact_url) + '">open</a>'
          : '-';
        const blocker = task.blocker_type
          ? '<span class="pill pill-blocker" title="' + escapeHTML(task.blocker_message || task.blocker_type) + '">' + escapeHTML(compactText(task.blocker_type, 20)) + '</span>'
          : '-';

        return (
          '<tr data-task-id="' + escapeHTML(task.id) + '"' + rowClass + '>' +
            '<td class="mono"' + idStyle + ' title="' + escapeHTML(task.id) + '">' + escapeHTML(compactText(task.id || '-', 20)) + '</td>' +
            '<td><span class="pill ' + statusPillClass(task.status) + '">' + escapeHTML(task.status || 'unknown') + '</span></td>' +
            '<td title="' + escapeHTML(task.goal || '-') + '">' + escapeHTML(compactText(task.goal || '-', 64)) + '</td>' +
            '<td title="' + escapeHTML(task.final_url || task.url || '-') + '">' + escapeHTML(compactText(task.final_url || task.url || '-', 42)) + '</td>' +
            '<td class="mono" title="' + escapeHTML(task.node_id || '-') + '">' + escapeHTML(compactText(task.node_id || '-', 18)) + '</td>' +
            '<td class="mono">' + escapeHTML(String(task.attempt || 0)) + '/' + escapeHTML(String(task.max_retries || 0)) + '</td>' +
            '<td class="mono">' + escapeHTML(fmtTime(task.created_at)) + '</td>' +
            '<td class="mono">' + escapeHTML(durationForTask(task)) + '</td>' +
            '<td>' + blocker + '</td>' +
            '<td>' + artifact + '</td>' +
          '</tr>'
        );
      }).join('');
    }

    function renderDetail() {
      const task = state.filteredTasks.find((item) => item.id === state.selectedTaskID)
        || state.tasks.find((item) => item.id === state.selectedTaskID);

      if (!task) {
        taskDetailEl.innerHTML = '<div class="empty">Select a task row to inspect full details.</div>';
        return;
      }

      const actionsJSON = JSON.stringify(task.actions || [], null, 2);
      const artifactButton = task.screenshot_artifact_url
        ? '<button type="button" class="btn btn-secondary" data-artifact="' + escapeHTML(task.screenshot_artifact_url) + '">Preview Artifact</button>'
        : '';
      const openArtifactLink = task.screenshot_artifact_url
        ? '<a class="link mono" href="' + escapeHTML(task.screenshot_artifact_url) + '" target="_blank" rel="noopener noreferrer">' + escapeHTML(task.screenshot_artifact_url) + '</a>'
        : '-';
      const sourceTask = task.source_task_id
        ? '<button type="button" class="link-btn" data-select-task-id="' + escapeHTML(task.source_task_id) + '">' + escapeHTML(task.source_task_id) + '</button>'
        : '-';

      taskDetailEl.innerHTML = (
        '<div class="detail-header">' +
          '<div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">' +
            '<div class="detail-id">' + escapeHTML(task.id || '-') + '</div>' +
            '<span class="pill ' + statusPillClass(task.status) + '">' + escapeHTML(task.status || 'unknown') + '</span>' +
          '</div>' +
          '<div class="panel-note">Selected task details and replay controls.</div>' +
        '</div>' +
        '<div class="detail-list">' +
          '<div class="pair"><span class="k">Goal</span><span class="v">' + escapeHTML(task.goal || '-') + '</span></div>' +
          '<div class="pair"><span class="k">Source Task</span><span class="v">' + sourceTask + '</span></div>' +
          '<div class="pair"><span class="k">URL</span><span class="v">' + escapeHTML(task.url || '-') + '</span></div>' +
          '<div class="pair"><span class="k">Final URL</span><span class="v">' + escapeHTML(task.final_url || '-') + '</span></div>' +
          '<div class="pair"><span class="k">Node ID</span><span class="v mono">' + escapeHTML(task.node_id || '-') + '</span></div>' +
          '<div class="pair"><span class="k">Attempts</span><span class="v mono">' + escapeHTML(String(task.attempt || 0)) + '/' + escapeHTML(String(task.max_retries || 0)) + '</span></div>' +
          '<div class="pair"><span class="k">Timeline</span><span class="v mono">created: ' + escapeHTML(fmtTime(task.created_at)) + '<br>started: ' + escapeHTML(fmtTime(task.started_at)) + '<br>completed: ' + escapeHTML(fmtTime(task.completed_at)) + '</span></div>' +
          '<div class="pair"><span class="k">Blocker</span><span class="v">' + escapeHTML((task.blocker_type || '-') + (task.blocker_message ? (': ' + task.blocker_message) : '')) + '</span></div>' +
          '<div class="pair"><span class="k">Error</span><span class="v">' + escapeHTML(task.error_message || '-') + '</span></div>' +
          '<div class="pair"><span class="k">Artifact URL</span><span class="v">' + openArtifactLink + '</span></div>' +
          '<div class="pair"><span class="k">Actions JSON</span><pre class="json">' + escapeHTML(actionsJSON) + '</pre></div>' +
        '</div>' +
        '<div class="detail-actions">' +
          '<button type="button" class="btn btn-primary" id="replay-btn">Replay Task</button>' +
          artifactButton +
          '<button type="button" class="btn btn-danger" id="clear-selection-btn">Clear Selection</button>' +
        '</div>'
      );

      const replayBtn = document.getElementById('replay-btn');
      if (replayBtn) {
        replayBtn.addEventListener('click', () => replayTask(task));
      }

      const clearBtn = document.getElementById('clear-selection-btn');
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          state.selectedTaskID = '';
          renderTaskTable();
          renderDetail();
        });
      }
    }

    function renderFailures() {
      const failures = state.tasks
        .filter((task) => task.status === 'failed')
        .slice(0, 8);

      if (!failures.length) {
        errorsEl.innerHTML = '<div class="empty">No failed tasks in the fetched set.</div>';
        return;
      }

      errorsEl.innerHTML = failures.map((task) => {
        const blocker = task.blocker_type
          ? '<div><strong>blocker:</strong> ' + escapeHTML(task.blocker_type + (task.blocker_message ? ' - ' + task.blocker_message : '')) + '</div>'
          : '';
        return (
          '<div class="error-item" data-task-id="' + escapeHTML(task.id) + '">' +
            '<div class="error-id">' + escapeHTML(task.id || '-') + '</div>' +
            '<div><strong>goal:</strong> ' + escapeHTML(compactText(task.goal || '-', 120)) + '</div>' +
            '<div><strong>error:</strong> ' + escapeHTML(compactText(task.error_message || '-', 160)) + '</div>' +
            blocker +
          '</div>'
        );
      }).join('');
    }

    function renderAll() {
      updateClock();
      updateKPIs();
      applyFilters();
      renderNodes();
      renderTaskTable();
      renderDetail();
      renderFailures();

      footerMetaEl.textContent =
        'nodes=' + state.nodes.length +
        ' | tasks=' + state.tasks.length +
        ' | filtered=' + state.filteredTasks.length +
        ' | blocked=' + state.tasks.filter((task) => Boolean(task.blocker_type)).length +
        ' | live=' + (state.isLive ? 'on' : 'off') +
        ' | interval=' + state.refreshMs + 'ms';
    }

    async function requestJSON(url, options) {
      const response = await fetch(url, options);
      const text = await response.text();
      let payload = {};

      if (text) {
        try {
          payload = JSON.parse(text);
        } catch (_error) {
          throw new Error('invalid json from ' + url + ': ' + text.slice(0, 120));
        }
      }

      if (!response.ok) {
        const message = payload.message || payload.error || ('request failed: ' + response.status);
        throw new Error(message);
      }

      return payload;
    }

    async function refreshDashboard() {
      const now = new Date();
      try {
        const [nodeResp, taskResp] = await Promise.all([
          requestJSON('/v1/nodes'),
          requestJSON('/v1/tasks?limit=' + encodeURIComponent(state.taskLimit))
        ]);

        state.nodes = Array.isArray(nodeResp.nodes) ? nodeResp.nodes : [];
        state.tasks = Array.isArray(taskResp.tasks) ? taskResp.tasks : [];

        const exists = state.tasks.some((task) => task.id === state.selectedTaskID);
        if (!exists) {
          state.selectedTaskID = '';
        }

        refreshStatusEl.textContent = 'last refresh ' + now.toLocaleTimeString();
        renderAll();
      } catch (error) {
        refreshStatusEl.textContent = 'refresh failed: ' + error.message;
      }
    }

    function restartTimer() {
      if (state.timer) {
        clearInterval(state.timer);
        state.timer = null;
      }
      if (!state.isLive) return;
      state.timer = setInterval(refreshDashboard, state.refreshMs);
    }

    async function createSession() {
      const tenantID = document.getElementById('tenant-id').value.trim() || 'dashboard';
      const created = await requestJSON('/v1/sessions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tenant_id: tenantID })
      });
      document.getElementById('session-id').value = created.id || '';
      return created.id || '';
    }

    async function ensureSessionID() {
      const sessionInput = document.getElementById('session-id');
      let sessionID = sessionInput.value.trim();
      if (sessionID) return sessionID;
      sessionID = await createSession();
      return sessionID;
    }

    async function queueTask(payload) {
      const task = await requestJSON('/v1/tasks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      state.lastCreatedTaskID = task.id || '';
      state.selectedTaskID = task.id || '';
      return task;
    }

    async function replayTask(task) {
      const payload = {};
      const sessionOverride = document.getElementById('session-id').value.trim();
      const retriesInput = Number.parseInt(document.getElementById('task-retries').value, 10);
      if (sessionOverride) {
        payload.session_id = sessionOverride;
      }
      if (Number.isFinite(retriesInput)) {
        payload.max_retries = retriesInput;
      }

      try {
        createStatusEl.textContent = 'Replaying task ' + (task.id || '-') + '...';
        const created = await requestJSON('/v1/tasks/' + encodeURIComponent(task.id || '') + '/replay', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        state.lastCreatedTaskID = created.id || '';
        state.selectedTaskID = created.id || '';
        createStatusEl.innerHTML = 'Replay queued as <span class="mono">' + escapeHTML(created.id || '-') + '</span>.';
        await refreshDashboard();
      } catch (error) {
        createStatusEl.textContent = 'Replay failed: ' + error.message;
      }
    }

    function applyPreset(value) {
      const urlInput = document.getElementById('task-url');
      const goalInput = document.getElementById('task-goal');
      const actionsInput = document.getElementById('task-actions');

      if (value === 'duck-search') {
        urlInput.value = 'https://duckduckgo.com';
        goalInput.value = 'search for browser use';
        actionsInput.value = JSON.stringify([
          { type: 'wait_for', selector: 'input[name="q"]', timeout_ms: 10000 },
          { type: 'type', selector: 'input[name="q"]', text: 'browser use' },
          { type: 'press_enter', selector: 'input[name="q"]' },
          { type: 'wait_for_url_contains', text: 'browser use', timeout_ms: 12000 },
          { type: 'wait', delay_ms: 800 }
        ], null, 2);
        return;
      }

      if (value === 'wiki-search') {
        urlInput.value = 'https://www.wikipedia.org';
        goalInput.value = 'search for browser automation';
        actionsInput.value = JSON.stringify([
          { type: 'wait_for', selector: 'input[name="search"]', timeout_ms: 10000 },
          { type: 'type', selector: 'input[name="search"]', text: 'browser automation' },
          { type: 'press_enter', selector: 'input[name="search"]' },
          { type: 'wait_for_url_contains', text: 'browser automation', timeout_ms: 12000 },
          { type: 'wait', delay_ms: 800 }
        ], null, 2);
        return;
      }

      if (value === 'open-url') {
        urlInput.value = 'https://example.com';
        goalInput.value = 'open page and capture screenshot';
        actionsInput.value = '';
        return;
      }
    }

    function bindControls() {
      document.getElementById('refresh-ms').addEventListener('change', (event) => {
        state.refreshMs = Number.parseInt(event.target.value, 10) || 3000;
        restartTimer();
      });

      document.getElementById('task-limit').addEventListener('change', async (event) => {
        state.taskLimit = Number.parseInt(event.target.value, 10) || 120;
        document.getElementById('task-limit-label').textContent = '/v1/tasks?limit=' + state.taskLimit;
        await refreshDashboard();
      });

      document.getElementById('toggle-live-btn').addEventListener('click', () => {
        state.isLive = !state.isLive;
        const button = document.getElementById('toggle-live-btn');
        button.textContent = state.isLive ? 'Pause Live Updates' : 'Resume Live Updates';
        liveLabelEl.textContent = state.isLive ? 'Live polling enabled' : 'Live polling paused';
        restartTimer();
      });

      document.getElementById('refresh-now-btn').addEventListener('click', refreshDashboard);

      document.getElementById('preset').addEventListener('change', (event) => {
        applyPreset(event.target.value);
      });

      document.getElementById('create-session-btn').addEventListener('click', async () => {
        const button = document.getElementById('create-session-btn');
        const prev = button.textContent;
        button.disabled = true;
        button.textContent = 'Creating...';
        try {
          const id = await createSession();
          createStatusEl.textContent = 'Created session: ' + id;
        } catch (error) {
          createStatusEl.textContent = 'Session creation failed: ' + error.message;
        } finally {
          button.disabled = false;
          button.textContent = prev;
        }
      });

      document.getElementById('task-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const submit = event.submitter;
        const prev = submit.textContent;
        const url = document.getElementById('task-url').value.trim();
        const goal = document.getElementById('task-goal').value.trim();
        const retries = Number.parseInt(document.getElementById('task-retries').value, 10);
        const rawActions = document.getElementById('task-actions').value.trim();

        if (!url) {
          createStatusEl.textContent = 'URL is required.';
          return;
        }

        let actions = [];
        if (rawActions) {
          try {
            actions = JSON.parse(rawActions);
            if (!Array.isArray(actions)) {
              throw new Error('actions must be a JSON array');
            }
          } catch (error) {
            createStatusEl.textContent = 'Invalid actions JSON: ' + error.message;
            return;
          }
        }

        submit.disabled = true;
        submit.textContent = 'Queuing...';
        try {
          const sessionID = await ensureSessionID();
          const payload = {
            session_id: sessionID,
            url,
            goal,
            max_retries: Number.isFinite(retries) ? retries : 1
          };
          if (actions.length) payload.actions = actions;

          const created = await queueTask(payload);
          createStatusEl.innerHTML = 'Queued task <span class="mono">' + escapeHTML(created.id || '-') + '</span> (' + escapeHTML(created.status || '-') + ').';
          await refreshDashboard();
        } catch (error) {
          createStatusEl.textContent = 'Task queue failed: ' + error.message;
        } finally {
          submit.disabled = false;
          submit.textContent = prev;
        }
      });

      document.getElementById('filter-status').addEventListener('change', (event) => {
        state.filters.status = event.target.value;
        renderAll();
      });

      document.getElementById('filter-query').addEventListener('input', (event) => {
        state.filters.query = event.target.value;
        renderAll();
      });

      document.getElementById('filter-artifact').addEventListener('change', (event) => {
        state.filters.artifact = event.target.value;
        renderAll();
      });

      document.getElementById('filter-only-failed').addEventListener('change', (event) => {
        state.filters.onlyFailed = event.target.value === 'on';
        renderAll();
      });

      document.getElementById('filter-blocker').addEventListener('change', (event) => {
        state.filters.blocker = event.target.value;
        renderAll();
      });

      document.getElementById('sort-order').addEventListener('change', (event) => {
        state.filters.sort = event.target.value;
        renderAll();
      });

      document.getElementById('clear-filters-btn').addEventListener('click', () => {
        state.filters.status = 'all';
        state.filters.query = '';
        state.filters.artifact = 'all';
        state.filters.onlyFailed = false;
        state.filters.blocker = 'all';
        state.filters.sort = 'newest';

        document.getElementById('filter-status').value = 'all';
        document.getElementById('filter-query').value = '';
        document.getElementById('filter-artifact').value = 'all';
        document.getElementById('filter-only-failed').value = 'off';
        document.getElementById('filter-blocker').value = 'all';
        document.getElementById('sort-order').value = 'newest';
        renderAll();
      });

      document.addEventListener('click', (event) => {
        const artifactTarget = event.target.closest('[data-artifact]');
        if (artifactTarget) {
          event.preventDefault();
          const url = artifactTarget.getAttribute('data-artifact');
          if (!url) return;
          imagePreviewEl.src = url;
          imageTitleEl.textContent = url;
          imageModalEl.classList.add('show');
          return;
        }

        const selectTaskTarget = event.target.closest('[data-select-task-id]');
        if (selectTaskTarget) {
          const sourceID = selectTaskTarget.getAttribute('data-select-task-id');
          if (!sourceID) return;
          const exists = state.tasks.some((task) => task.id === sourceID);
          if (exists) {
            state.selectedTaskID = sourceID;
            renderTaskTable();
            renderDetail();
          } else {
            state.filters.query = sourceID;
            document.getElementById('filter-query').value = sourceID;
            renderAll();
            createStatusEl.textContent = 'Source task ' + sourceID + ' is not in current fetch window; search filter was applied.';
          }
          return;
        }

        const row = event.target.closest('[data-task-id]');
        if (row && row.tagName === 'TR') {
          const id = row.getAttribute('data-task-id');
          if (!id) return;
          state.selectedTaskID = id;
          renderTaskTable();
          renderDetail();
          return;
        }

        const errorRow = event.target.closest('.error-item[data-task-id]');
        if (errorRow) {
          const id = errorRow.getAttribute('data-task-id');
          if (!id) return;
          state.selectedTaskID = id;
          renderTaskTable();
          renderDetail();
        }
      });

      document.getElementById('image-close').addEventListener('click', closeModal);
      imageModalEl.addEventListener('click', (event) => {
        if (event.target === imageModalEl) closeModal();
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') closeModal();
      });
    }

    function closeModal() {
      imageModalEl.classList.remove('show');
      imagePreviewEl.src = '';
    }

    bindControls();
    updateClock();
    setInterval(updateClock, 1000);
    refreshDashboard();
    restartTimer();
  </script>
</body>
</html>
